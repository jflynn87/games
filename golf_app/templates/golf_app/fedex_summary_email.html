{%load static%}
{%load bootstrap%}
{%load compress%}
{%load golf_extras%}


{% block body_block %}


<h3 style="text-align:center;">Score Summary {{fedex_season}}</h3>
<br>
<br>
<div class="row">

<div id="summary-section" class="col">
    <h5 style="text-align:center;">Summary Data</h5>
    <table id="summary-table" class="table table-bordered table-sm">
        <thead style="background-color: lightgray;">
            <tr>
                <th></th>
                {%for k, v in display_dict.user_data.items%}
                    {%if k not in 'details, into_top30, out_top30'%}
                <th>{{k|slice:"0:4"}}</th>
                {%endif%}
                {%endfor%}
            </tr>
        </thead>

        <tr id="total_score_row">
            <th style="text-align:left;">Season Total</th>
            {%for user, data in display_dict.user_data.items%}
                <td>{{data.total}}</td>
            {%endfor%}

        </tr> 
        <tr id="total_rank_row">
            <th style="text-align:left;">Season Rank</th>
            {%for user, data in display_dict.user_data.items%}
                <td>{{data.rank}}</td>
                
            {%endfor%}
        </tr>
        <tr>
            <td colspan="12" style="background-color: lightblue;"></td>
        </tr>
        <tr id="fedex_total_row">
            <th style="text-align:left;">FedEx Points</th>
            {%for user, data in display_dict.user_data.items%}
            <td>{{data.fed_ex_score}}</td>
            {%endfor%}
        </tr>
        <tr id="fedex_rank_row">
            <th style="text-align:left;">Rank</th>
            {%for user, data in display_dict.user_data.items%}
            <td>{{data.fed_ex_rank}}</td>
            {%endfor%}

        </tr>
        <tr>
            <td colspan="12" style="background-color: lightblue;"></td>
        </tr>
        <tr id="in_top30_row">
            <th style="text-align:left;">In Top 30</th>
            {%for user, data in display_dict.user_data.items%}
            <td>{{data.in_top30}}</td>
            {%endfor%}

        </tr>
        <tr id="outside_top30_row">
            <th style="text-align:left;">Outside Top 30</th>
            {%for user, data in display_dict.user_data.items%}
            <td>{{data.outside_top30}}</td>
            {%endfor%}
        </tr>
        <tr id="minus_80_row">
            <th style="text-align:left;">-80 Picks</th>
            {%for user, data in display_dict.user_data.items%}
            <td>{{data.minus_80}}</td>
            {%endfor%}
        </tr>
        <tr id="plus_20_row">
            <th style="text-align:left;">+20 Picks</th>
            {%for user, data in display_dict.user_data.items%}
            <td>{{data.plus_20}}</td>
            {%endfor%}
        </tr>
        <tr id="at_risk">
            <th style="text-align:left;">At Risk 
                <a id="tt-risk" data-toggle="tooltip" title="FedEx Rank 20-30 >30"><i class="fa fa-info-circle" style="color:blue;"></i> </a></th>
                {%for user, data in display_dict.user_data.items%}
                <td>{{data.at_risk}}</td>
                {%endfor%}
        </tr>
        <tr id="onthe_verge">
            <th style="text-align:left;">On the Verge</th>
                {%for user, data in display_dict.user_data.items%}
                <td>{{data.onthe_verge}}</td>
                {%endfor%}
        </tr>
        <tr>
            <td colspan="12" style="background-color: lightblue;"></td>
        </tr>
        <tr id="into_top30">
            <th style="text-align:left;">Player Moves into Top30</th>
            {%for k, v in display_dict.into_top30.items%}
            <tr>
            <td>{{k}}</td>
            </tr>
            {%endfor%}
    
        </tr>
        <tr id="out_top30">
        <th style="text-align:left;">Player Moves out of Top30</th>
        {%for k, v in display_dict.out_top30.items%}
        <tr>
        <td>{{k}}</td>
        </tr>
        {%endfor%}
    </tr>

</table>


<!-- <script>

console.log('starting ')
const pbs = picksByScore();
const inout = inOut()

f_array= [pbs, inout]

Promise.all(f_array).then((response) =>  {
                            console.log('back')
                            $('#summary-section').append('<p id=done hidden>Done</p>')
                                        })

function picksByScore() {
        return new Promise(function(resolve, reject) {
            
        console.log('picks by score')
        fetch("/golf_app/fedex_picks_by_score/" + '{{fedex_season.pk}}',         
                {method: "GET",})
        .then((response) => response.json())
        .then((responseJSON) => {
            console.log('back from fetch')
            var data = $.parseJSON(responseJSON)
            var orderList = $.parseJSON('{{order|js}}')
            order_l = orderList.length 
            $('#status_20').remove()
            $('#status_80').remove()
            $('#status_at_risk').remove()
            $('#status_verge').remove()
            //$('#minus_80_row td')[1].remove()
            for (let i=0; i< order_l; i++) {
                
                 $('#minus_80_row').append('<td>' + data[orderList[i]].minus_80 + '</td>')
                 $('#plus_20_row').append('<td>' + data[orderList[i]].plus_20 + '</td>')
                 $('#at_risk').append('<td>' + data[orderList[i]].at_risk + '</td>')
                 $('#onthe_verge').append('<td>' + data[orderList[i]].onthe_verge + '</td>')
            }
        })
        .then((response) => {console.log('resolving pbs')
            resolve()  })

    })
}

function inOut() {
    return new Promise(function(resolve, reject) {
        console.log('in/out top30')
        fetch("/golf_app/fedex_in_out/",         
                {method: "GET",})
        .then((response) => response.json())
        .then((responseJSON) => {
            
            var data = $.parseJSON(responseJSON)
            var orderList = $.parseJSON('{{order|js}}')
            order_l = orderList.length 
            $('#into_top30').remove()
            $('#out_top30').remove()
            $('#summary-table').append('<tr><th colspan=12>Player Moves into Top 30</th></tr>')
            for (let i=0; i < Object.keys(data.into_top30).length; i++) {
                $('#summary-table').append('<tr id=into_top30-' + i +'><td> ' + Object.keys(data.into_top30)[i] + '</td></tr>')
                $.each($.parseJSON('{{order|js}}'), function(j, user) {
                            var td = document.createElement('td')
                            if (Object.values(data.into_top30)[i].indexOf(user) != -1) {
                               //td.innerHTML = 'X'
                                check = document.createElement('i')
                                check.classList = ["fas fa-check"]
                                check.style.color = 'green'
                                td.appendChild(check)
                                                          }
                            else {td.innerHTML = ""}
                        document.getElementById('into_top30-' + i).appendChild(td)
                    })
                }

            $('#summary-table').append('<tr><th colspan=12>Moves out of Top 30</th></tr>')
            for (let i=0; i < Object.keys(data.out_top30).length; i++) {
                $('#summary-table').append('<tr id=out_top30-' + i + '><td> ' + Object.keys(data.out_top30) + '</td></tr>')
                $.each($.parseJSON('{{order|js}}'), function(j, user) {
                            var td = document.createElement('td')
                            if (Object.values(data.out_top30)[i].indexOf(user) != -1) {
                                //td.innerHTML = 'X'
                                check = document.createElement('i')
                                check.classList = ["fas fa-times-circle"]
                                check.style.color = 'red'
                                td.appendChild(check)
                                //.html('<i class="fas fa-check"></i>').css('color', 'green')
                                                          }
                            else {td.innerHTML = ""}
                        document.getElementById('out_top30-' + i).appendChild(td)
                    })
            }

            })
            .then((response) => {console.log('resolving inout')
            resolve()  })

        })
    }


</script>
 -->
</div>
<div id="detail_div" class="col">
    <h5 style="text-align:center;">Detail</h5>
    <table id="detail-table" class="table table-bordered table-sm">
        <thead>
            <tr style="background-color: lightgray;">
                <th>Golfer</th>
                <th>FedEx Rank</th>
                <th>SOY OWGR</th>
                {%for k, v in display_dict.user_data.items%}
                    <th>{{k|slice:"0:4"}}</th>
                {%endfor%}
            </tr>
        </thead>
        {%for golfer, data in display_dict.details.items%}
            <tr>
                <td>{{golfer}}</td>
                <td>{{data.rank}}</td>
                <td>{{data.soy_owgr}}</td>
                {%for u, score in data.user_dict.items%}
                    {%if score == -30%}
                    <td style="color: blue;">{{score}}</td>
                    {%elif score == -80%}
                    <td style="color: green">{{score}}</td>
                    {%elif score == 20%}
                    <td style="color: red">{{score}}</td>
                    {%else%}
                    <td>{{score}}</td>
                    {%endif%}
                    
                {%endfor%}
            </tr>
        {%endfor%}
<!--             <script type="text/javascript">
                header = document.createElement('thead')
                header.style.backgroundColor = 'lightgray'
                row = document.createElement('tr')
                firstCell = document.createElement('th')
                secondCell = document.createElement('th')
                secondCell.innerHTML = 'FedEx Rank'
                thirdCell = document.createElement('th')
                thirdCell.innerHTML = 'OWGR'  //add a tool tip here for the logic on when this was set
                row.appendChild(firstCell)
                row.appendChild(secondCell)
                row.appendChild(thirdCell)
               var orderList = $.parseJSON('{{order|js}}')
               for (let i=0; i < orderList.length; i++) {
                   cell = document.createElement('th')
                   cell.innerHTML = orderList[i].substring(0,4)
                   row.appendChild(cell)
               } 
               header.appendChild(row)
               document.getElementById('detail-table').appendChild(header)
               $('#detail-table').append('<tr id=detail-table-status><td>Loading<span class=status>...</span></td></tr>')

               $('#detail-table').ready(function()  {

                fetch("/golf_app/fedex_detail_api/" + '{{fedex_season.pk}}',         
                {method: "GET",})
                .then((response) => response.json())
                .then((responseJSON) => {
            
                    var data = $.parseJSON(responseJSON)
                    var orderList = $.parseJSON('{{order|js}}')
                    
                    data_l = Object.keys(data).length
                    $('#detail-table-status').remove()
                    for (let i=0; i< data_l; i++) {
                        var row = document.createElement('tr')
                        var tdA = document.createElement('td')
                        tdA.innerHTML = Object.keys(data)[i]
                        tdA.style.fontWeight = 'bold'
                        var tdB = document.createElement('td')
                        tdB.innerHTML = Object.values(data)[i].rank
                        var tdC = document.createElement('td')
                        tdC.innerHTML = Object.values(data)[i].soy_owgr
                        row.appendChild(tdA)
                        row.appendChild(tdB)
                        row.appendChild(tdC)
                        //document.getElementById('detail-table').appendChild(row)

                        $.each($.parseJSON('{{order|js}}'), function(j, user) {
                            var td = document.createElement('td')

                            if (Object.values(data)[i].user_list.indexOf(user) != -1) {
                                //td.innerHTML = Object.values(data)[i].user
                                td.innerHTML = Object.values(data)[i].score
                                
                                if (Object.values(data)[i].score.toString() == '-80') {
                                    td.style.color = 'green'
                                    td.style.fontWeight = 'bold'
                                }
                                else if (Object.values(data)[i].score.toString() == '-30') {
                                    td.style.color = 'blue'
                                }
                                else if (Object.values(data)[i].score.toString() == '20') {
                                    td.style.color = 'red'
                                }
                            }
                            else {td.innerHTML = ''}
                            row.appendChild(td)
                        })

                        document.getElementById('detail-table').appendChild(row)
                    // $('#into_top30').append('<td> ' + Object.keys(data[orderList[i]].into_top30) + '</td>')
                    // $('#out_top30').append('<td>' + Object.keys(data[orderList[i]].out_top30) + '</td>')
            }
            })
        })

            </script>    
 -->        

    </table>
</div>
</div>

{%endblock%}